# SLURM Partition Configuration for softmig (Digital Research Alliance Canada)
# Add these partitions to /etc/slurm/slurm.conf
# Keep your existing partitions and add these new ones

# ===== HALF GPU SLICED PARTITIONS (2x oversubscription) =====
# Each job gets 24GB memory, 50% SM utilization
# OverSubscribe=YES:2 allows 2 jobs per GPU

PartitionName=gpuhalf_bygpu_b1 Nodes=p1,p2,p3,p4,p5 MaxTime=3:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:2 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.2=5150

PartitionName=gpuhalf_bygpu_b2 Nodes=p2,p3,p4,p5 MaxTime=12:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:2 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.2=5150

PartitionName=gpuhalf_bygpu_b3 Nodes=p3,p4,p5 MaxTime=24:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:2 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.2=5150

PartitionName=gpuhalf_bygpu_b4 Nodes=p3,p4,p5 MaxTime=3-00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:2 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.2=5150

PartitionName=gpuhalf_bygpu_b5 Nodes=p5 MaxTime=7-00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:2 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.2=5150

# ===== QUARTER GPU SLICED PARTITIONS (4x oversubscription) =====
# Each job gets 12GB memory, 25% SM utilization
# OverSubscribe=YES:4 allows 4 jobs per GPU

PartitionName=gpuquarter_bygpu_b1 Nodes=p1,p2,p3,p4,p5 MaxTime=3:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:4 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.4=2575

PartitionName=gpuquarter_bygpu_b2 Nodes=p2,p3,p4,p5 MaxTime=12:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:4 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.4=2575

PartitionName=gpuquarter_bygpu_b3 Nodes=p3,p4,p5 MaxTime=24:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:4 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.4=2575

PartitionName=gpuquarter_bygpu_b4 Nodes=p3,p4,p5 MaxTime=3-00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:4 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.4=2575

PartitionName=gpuquarter_bygpu_b5 Nodes=p5 MaxTime=7-00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:4 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.4=2575

# ===== INTERACTIVE PARTITIONS FOR SLICED GPUs =====

PartitionName=gpuhalf_interac Nodes=compute MaxTime=8:00:00 DefaultTime=0:10:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:2 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.2=5150

PartitionName=gpuquarter_interac Nodes=compute MaxTime=8:00:00 DefaultTime=0:10:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:4 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.4=2575

# ===== EIGHTH GPU SLICED PARTITIONS (8x oversubscription) =====
# Each job gets 6GB memory, 12.5% SM utilization
# OverSubscribe=YES:8 allows 8 jobs per GPU

PartitionName=gpueighth_bygpu_b1 Nodes=p1,p2,p3,p4,p5 MaxTime=3:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:8 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.8=1287

PartitionName=gpueighth_bygpu_b2 Nodes=p2,p3,p4,p5 MaxTime=12:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:8 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.8=1287

PartitionName=gpueighth_bygpu_b3 Nodes=p3,p4,p5 MaxTime=24:00:00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:8 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.8=1287

PartitionName=gpueighth_bygpu_b4 Nodes=p3,p4,p5 MaxTime=3-00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:8 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.8=1287

PartitionName=gpueighth_bygpu_b5 Nodes=p5 MaxTime=7-00 DefaultTime=1:00:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:8 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.8=1287

PartitionName=gpueighth_interac Nodes=compute MaxTime=8:00:00 DefaultTime=0:10:00 \
    DefMemPerNode=500 State=UP OverSubscribe=YES:8 \
    TRESBillingWeights=CPU=643.75,Mem=81.10G,GRES/gpu:l40s.8=1287

# ===== ACCOUNTING CONFIGURATION =====
# Add to slurm.conf:
# AccountingStorageTRES=gres/gpu,gres/gpu:l40s,gres/gpu:l40s.1,gres/gpu:l40s.2,gres/gpu:l40s.4,gres/gpu:l40s.8,cpu,mem
# PriorityWeightTRES=CPU=15000,Mem=15000,GRES/gpu=15000,GRES/gpu:l40s=15000,GRES/gpu:l40s.1=15000,GRES/gpu:l40s.2=7500,GRES/gpu:l40s.4=3750,GRES/gpu:l40s.8=1875

# Notes:
# - TRESBillingWeights reflect the fractional value (half=5150, quarter=2575, eighth=1287)
# - OverSubscribe values match the slice type (2x for half, 4x for quarter, 8x for eighth)
# - softmig enforces the actual limits via LD_PRELOAD

